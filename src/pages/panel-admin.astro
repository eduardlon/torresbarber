---
export const prerender = false;

// Verificar autenticación del administrador
const adminSession = Astro.cookies.get('admin_session');
const authToken = Astro.cookies.get('auth_token');

// Verificación básica de cookies - más permisiva para debugging
if (!authToken || !authToken.value) {
  console.log('No auth token found, redirecting to login');
  return Astro.redirect('/login-admin');
}

// Verificar token con la API de Laravel
try {
  // Detectar si estamos en localhost o en la red
  const isLocalhost = Astro.url.hostname === 'localhost' || Astro.url.hostname === '127.0.0.1';
  const apiHost = isLocalhost ? 'localhost' : Astro.url.hostname;
  const apiBaseUrl = `http://${apiHost}:8001/api`;
  
  const response = await fetch(`${apiBaseUrl}/verify-token`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${authToken.value}`,
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    }
  });
  
  if (!response.ok) {
    console.log('Token verification failed, status:', response.status);
    // Solo redirigir si es un error de autenticación específico (401/403)
    if (response.status === 401 || response.status === 403) {
      return Astro.redirect('/login-admin');
    }
    // Para otros errores, permitir acceso temporal
    console.log('Allowing temporary access due to server error');
  } else {
    const userData = await response.json();
    console.log('Acceso autorizado al panel admin. Usuario:', userData.user.name);
  }
} catch (error) {
  console.log('Error verificando token:', error);
  // En caso de error de conexión, permitir acceso temporal
  console.log('Allowing temporary access due to connection error');
}

import Layout from '../layouts/Layout.astro';
import AdminPanel from '../components/AdminPanel.tsx';
---

<Layout title="Panel de Administración - JP Barber">
	<main class="min-h-screen bg-gradient-to-br from-black via-gray-900 to-black">
		<AdminPanel client:load />
	</main>
</Layout>

<style>
	body {
		margin: 0;
		padding: 0;
		background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #000000 100%);
		color: #ffffff;
	}
</style>
  
  <script>
    const fallbackGetAuthToken = () => {
      let token = localStorage.getItem('auth_token');

      if (!token) {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'auth_token') {
            token = value;
            localStorage.setItem('auth_token', token);
            break;
          }
        }
      }

      return token;
    };

    // Verificar y sincronizar token al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      const token = typeof window.getAuthToken === 'function'
        ? window.getAuthToken()
        : fallbackGetAuthToken();

      if (token) {
        const authTokenCookie = document.cookie.split(';').find(cookie => 
          cookie.trim().startsWith('auth_token=')
        );

        if (!authTokenCookie) {
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const cookieOptions = isLocalhost 
            ? 'path=/; SameSite=Lax; max-age=86400'
            : 'path=/; SameSite=Lax; max-age=86400';

          document.cookie = `auth_token=${token}; ${cookieOptions}`;
          document.cookie = `admin_session=authenticated; ${cookieOptions}`;

          console.log('Cookies set, reloading page');
          window.location.reload();
        }
      }
    });
  </script>

  <script type="module" lang="ts">
    import { supabase } from '../lib/supabase';

    type JsonValue = Record<string, unknown> | Array<unknown> | string | number | boolean | null;

    const makeJsonResponse = (payload: JsonValue, status = 200): Response =>
      new Response(JSON.stringify(payload), {
        status,
        headers: { 'Content-Type': 'application/json' }
      });

    const getDateRange = (filter: string | null) => {
      const start = new Date();
      start.setHours(0, 0, 0, 0);

      switch (filter) {
        case 'week':
          start.setDate(start.getDate() - 6);
          break;
        case 'month':
          start.setDate(1);
          break;
        case 'year':
          start.setMonth(0, 1);
          break;
        default:
          break;
      }

      const end = new Date();
      end.setHours(23, 59, 59, 999);

      return {
        start: start.toISOString(),
        end: end.toISOString()
      };
    };

    const mapCitaStatus = (status: string | null | undefined) => {
      switch (status) {
        case 'confirmed':
          return 'confirmada';
        case 'completed':
          return 'completada';
        case 'cancelled':
          return 'cancelada';
        case 'no_show':
          return 'no_asistio';
        case 'in_progress':
          return 'en_proceso';
        default:
          return 'pendiente';
      }
    };

    const formatTime = (isoString: string | null | undefined) => {
      if (!isoString) return '--:--';
      const date = new Date(isoString);
      return date.toLocaleTimeString('es-CO', {
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    const getDashboardStats = async (filter: string | null): Promise<Response> => {
      const { start, end } = getDateRange(filter);

      const [ventas, gastos, citas, productos] = await Promise.all([
        supabase
          .from('ventas')
          .select('total_final, created_at')
          .gte('created_at', start)
          .lte('created_at', end),
        supabase
          .from('gastos')
          .select('monto, fecha_gasto')
          .gte('fecha_gasto', start.split('T')[0])
          .lte('fecha_gasto', end.split('T')[0]),
        supabase
          .from('citas')
          .select('id, status, fecha_hora')
          .gte('fecha_hora', start)
          .lte('fecha_hora', end),
        supabase
          .from('ventas_productos')
          .select('cantidad')
          .gte('created_at', start)
          .lte('created_at', end)
      ]);

      const ingresos = (ventas.data || []).reduce((acc, venta) => acc + Number(venta.total_final || 0), 0);
      const gastosTotales = (gastos.data || []).reduce((acc, gasto) => acc + Number(gasto.monto || 0), 0);
      const productosVendidos = (productos.data || []).reduce((acc, producto) => acc + Number(producto.cantidad || 0), 0);

      const citasData = citas.data || [];
      const citasDelDia = citasData.length;
      const citasPendientes = citasData.filter((cita) => cita.status !== 'completed').length;

      return makeJsonResponse({
        success: true,
        data: {
          ingresos,
          gastos: gastosTotales,
          ganancias: ingresos - gastosTotales,
          productosVendidos,
          citasDelDia,
          citasPendientes
        }
      });
    };

    const getRecentSales = async (): Promise<Response> => {
      const { data, error } = await supabase
        .from('ventas')
        .select(`
          id,
          total_final,
          created_at,
          clientes:clientes(nombre),
          citas:citas(
            fecha_hora,
            servicios:servicios(nombre)
          )
        `)
        .order('created_at', { ascending: false })
        .limit(10);

      if (error) {
        console.warn('Error cargando ventas recientes:', error.message);
      }

      const ventas = (data || []).map((venta) => ({
        id: venta.id,
        cliente: venta.clientes?.nombre || 'Cliente',
        servicio: venta.citas?.servicios?.nombre || 'Servicio',
        monto: Number(venta.total_final || 0),
        hora: formatTime(venta.created_at)
      }));

      return makeJsonResponse({ success: true, data: ventas });
    };

    const getTodayAppointments = async (query: URLSearchParams): Promise<Response> => {
      const onlyToday = query.has('today');
      let request = supabase
        .from('citas')
        .select(`
          id,
          cliente_nombre,
          fecha_hora,
          status,
          servicios:servicios(nombre),
          barberos:barberos(nombre)
        `)
        .order('fecha_hora', { ascending: true });

      if (onlyToday) {
        const today = new Date();
        const start = new Date(today);
        start.setHours(0, 0, 0, 0);
        const end = new Date(today);
        end.setHours(23, 59, 59, 999);
        request = request
          .gte('fecha_hora', start.toISOString())
          .lte('fecha_hora', end.toISOString());
      }

      const { data, error } = await request;

      if (error) {
        console.warn('Error cargando citas:', error.message);
      }

      const citas = (data || []).map((cita) => ({
        id: cita.id,
        cliente: cita.cliente_nombre,
        servicio: cita.servicios?.nombre || 'Servicio',
        barbero: cita.barberos?.nombre || 'Barbero',
        hora: formatTime(cita.fecha_hora),
        estado: mapCitaStatus(cita.status)
      }));

      return makeJsonResponse({ success: true, data: citas });
    };

    const getBarberos = async (): Promise<Response> => {
      const { data, error } = await supabase
        .from('barberos')
        .select('*')
        .order('nombre', { ascending: true });

      if (error) {
        console.warn('Error cargando barberos:', error.message);
      }

      return makeJsonResponse({ success: true, data: data || [] });
    };

    type RouteHandler = (query: URLSearchParams) => Promise<Response>;

    const routeHandlers: Record<string, RouteHandler> = {
      'dashboard/stats': (query) => getDashboardStats(query.get('filter')),
      ventas: () => getRecentSales(),
      citas: (query) => getTodayAppointments(query),
      barberos: () => getBarberos()
    };

    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const domainSuffix = isLocalhost ? '' : `; Domain=.${window.location.hostname}`;
    const apiHost = isLocalhost ? 'localhost' : window.location.hostname;
    window.API_BASE_URL = `http://${apiHost}:8001/api`;

    declare global {
      interface Window {
        API_BASE_URL: string;
        getAuthToken: () => string | null;
        authenticatedFetch: (url: string, options?: RequestInit) => Promise<Response | undefined>;
        logout: () => Promise<void>;
      }
    }

    window.getAuthToken = function(): string | null {
      let token = localStorage.getItem('auth_token');

      if (!token) {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'auth_token') {
            token = value;
            localStorage.setItem('auth_token', token);
            break;
          }
        }
      }

      return token;
    };

    window.authenticatedFetch = async function(url: string, options: RequestInit = {}): Promise<Response | undefined> {
      const token = window.getAuthToken();
      if (!token) {
        window.location.href = '/login-admin';
        return undefined;
      }

      const defaultHeaders: Record<string, string> = {
        Authorization: `Bearer ${token}`,
        Accept: 'application/json'
      };

      const body = options.body;
      if (!(body instanceof FormData)) {
        defaultHeaders['Content-Type'] = 'application/json';
      }

      const headers: HeadersInit = {
        ...defaultHeaders,
        ...(options.headers || {})
      };

      const config: RequestInit = {
        ...options,
        headers
      };

      if (url.startsWith(window.API_BASE_URL)) {
        const relative = url.slice(window.API_BASE_URL.length).replace(/^\//, '');
        const [path, queryString] = relative.split('?');
        const handler = routeHandlers[path];

        if (!handler) {
          return makeJsonResponse({ success: false, message: `Ruta no soportada: ${path}` }, 404);
        }

        try {
          const query = new URLSearchParams(queryString || '');
          return await handler(query);
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Error interno';
          console.error('Error en proxy Supabase:', error);
          return makeJsonResponse({ success: false, message }, 500);
        }
      }

      const response = await fetch(url, config);

      if (response.status === 401) {
        localStorage.removeItem('auth_token');
        document.cookie = `admin_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax${domainSuffix}`;
        document.cookie = `auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax${domainSuffix}`;
        window.location.href = '/login-admin';
        return undefined;
      }

      return response;
    };

    window.logout = async function(): Promise<void> {
      try {
        await supabase.auth.signOut();
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
      } finally {
        localStorage.removeItem('auth_token');
        document.cookie = `admin_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax${domainSuffix}`;
        document.cookie = `auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax${domainSuffix}`;
        document.cookie = `user_data=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax${domainSuffix}`;
        window.location.href = '/login-admin';
      }
    };
  </script>
</body>
</html>